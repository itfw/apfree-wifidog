name: Build apfree-wifidog using OpenWrt 24.10.5 SDK (.zst)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 45

    steps:
      - name: Install dependencies
        run: |
          sudo apt update
          sudo apt install -y --no-install-recommends \
            build-essential clang flex bison g++ gawk gcc-multilib \
            gettext git libncurses-dev libssl-dev rsync unzip \
            zlib1g-dev file wget curl python3 zstd

      - name: Download OpenWrt 24.10.5 SDK (.zst) from Aliyun
        run: |
          SDK_URL="https://mirrors.aliyun.com/openwrt/releases/24.10.5/targets/x86/64/openwrt-sdk-24.10.5-x86-64_gcc-13.3.0_musl.Linux-x86_64.tar.zst"
          echo "Downloading SDK from: $SDK_URL"
          wget -q "$SDK_URL" -O sdk.tar.zst

          # Check if download succeeded
          if [ ! -s sdk.tar.zst ]; then
            echo "❌ SDK download failed (empty file). Please check if 24.10.5 exists."
            exit 1
          fi

          # Extract .tar.zst
          zstd -d sdk.tar.zst -o sdk.tar
          tar -xf sdk.tar
          rm -f sdk.tar sdk.tar.zst
          mv openwrt-sdk-* sdk
          cd sdk && pwd

      - name: Add apfree-wifidog feed
        run: |
          cd sdk
          # Add your custom feed
          echo "src-git liudf0716 https://github.com/liudf0716/chawrt-packages.git" >> feeds.conf

          # Use Aliyun mirror for official OpenWrt feeds (faster in China)
          sed -i 's|https://github.com/openwrt|https://mirrors.aliyun.com/openwrt/git|g' feeds.conf

          ./scripts/feeds update -a
          ./scripts/feeds install -a apfree-wifidog

      - name: Configure and compile
        run: |
          cd sdk
          echo "CONFIG_PACKAGE_apfree-wifidog=y" > .config
          make defconfig

          # Keep-alive to prevent GitHub timeout
          while true; do echo "⏳ Building apfree-wifidog... $(date)"; sleep 300; done &
          KEEPALIVE_PID=$!

          make package/apfree-wifidog/compile V=s -j$(nproc)

          kill $KEEPALIVE_PID || true

      - name: Find generated IPK
        id: find_ipk
        run: |
          IPK_FILE=$(find sdk/bin/packages -name "apfree-wifidog_*.ipk" | head -n1)
          if [ -z "$IPK_FILE" ]; then
            echo "❌ apfree-wifidog IPK not found!"
            ls -R sdk/bin/ 2>/dev/null || echo "bin/ directory missing"
            exit 1
          fi
          echo "ipk_path=$IPK_FILE" >> $GITHUB_ENV
          echo "✅ Found: $IPK_FILE"
          ls -lh "$IPK_FILE"

      - name: Upload IPK artifact
        uses: actions/upload-artifact@v4
        with:
          name: apfree-wifidog-openwrt-24.10.5-x86_64
          path: ${{ env.ipk_path }}
          retention-days: 7
