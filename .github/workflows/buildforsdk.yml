name: Build apfree-wifidog

on:
  workflow_dispatch:
  push:
    branches: [ "master" ]

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      SDK_URL: https://mirrors.aliyun.com/openwrt/releases/24.10.5/targets/x86/64/openwrt-sdk-24.10.5-x86-64_gcc-13.3.0_musl.Linux-x86_64.tar.zst
      NEW_PKG_HASH: 9dfcae62ddd77c7c00eabc76b45acba10ec2cd1ec0dbb022bfd357dc178609a3

    steps:
      - name: Install system dependencies
        run: |
          sudo apt update
          sudo apt install -y build-essential ccache flex bison gawk gettext \
            libncurses-dev python3 python3-pip rsync unzip xz-utils zlib1g-dev \
            libssl-dev zstd clang g++ gcc-multilib g++-multilib \
            gettext git libncurses5-dev python3-setuptools swig \
            unzip file wget curl libxml2-dev pkg-config autoconf automake \
            libtool m4

      - name: Download OpenWrt SDK
        run: |
          wget -O sdk.tar.zst "${SDK_URL}"
          mkdir -p openwrt-sdk
          zstd -d --long=31 sdk.tar.zst -c | tar -x -C openwrt-sdk --strip-components=1

      - name: Update and Install Feeds
        working-directory: openwrt-sdk
        run: |
          cat > feeds.conf << EOF
          src-git base https://git.openwrt.org/openwrt/openwrt.git;v24.10.5
          src-git packages https://github.com/liudf0716/packages.git;chawrt/24.10
          src-git luci https://github.com/liudf0716/luci.git;chawrt/24.10
          src-git routing https://git.openwrt.org/feed/routing.git
          src-git telephony https://git.openwrt.org/feed/telephony.git
          EOF
          
          ./scripts/feeds update -a

          #./scripts/feeds install libmnl libnetfilter-conntrack libnetfilter-queue zlib libuci libjson-c libevent2 openssl-util libnftnl bpf-headers
          #./scripts/feeds install apfree-wifidog libnetfilter-cthelper
          #./scripts/feeds install luci-app-apfree-wifidog
          ./scripts/feeds install -a

      - name: Patch apfree-wifidog Makefile
        working-directory: openwrt-sdk
        run: |
          MF="package/feeds/packages/apfree-wifidog/Makefile"
          
          echo "Patching $MF"
          sed -i "s|PKG_HASH:=.*|PKG_HASH:=${NEW_PKG_HASH}|" "$MF"
          
          sed -i 's/+libmnl/+libmnl +libnetfilter-cthelper +libnetfilter-queue/g' "$MF"
          
          if ! grep -q "CMake/Compile" "$MF"; then
            sed -i '/define Build\/Compile/a \\t$(call CMake\/Compile)' "$MF"
          fi

      - name: Configure and Compile
        working-directory: openwrt-sdk
        run: |
          cat > .config << EOF
          #CONFIG_TARGET_x86=y
          #CONFIG_TARGET_x86_64=y
          #CONFIG_PACKAGE_apfree-wifidog=y
          #CONFIG_PACKAGE_kmod-xdpi=y
          #CONFIG_PACKAGE_libmnl=y
          #CONFIG_PACKAGE_libnetfilter-cthelper=y
          #CONFIG_PACKAGE_libnetfilter-queue=y
          #CONFIG_PACKAGE_luci-app-apfree-wifidog=y
          #CONFIG_PACKAGE_luci-i18n-apfree-wifidog-zh-cn=y
          CONFIG_TARGET_x86=y
          CONFIG_TARGET_x86_64=y
          CONFIG_TARGET_x86_64_DEVICE_generic=y
          
          # 1. 基础应用包
          CONFIG_PACKAGE_apfree-wifidog=y
          CONFIG_PACKAGE_luci-app-apfree-wifidog=y
          CONFIG_PACKAGE_luci-i18n-apfree-wifidog-zh-cn=y
          
          # 2. 关键内核模块 (解决崩溃的关键)
          CONFIG_PACKAGE_kmod-xdpi=y
          CONFIG_PACKAGE_kmod-nfnetlink-queue=y
          CONFIG_PACKAGE_kmod-nf-conntrack-netlink=y
          CONFIG_PACKAGE_kmod-nf-ipt-tproxy=y
          CONFIG_PACKAGE_kmod-sched-bpf=y
          CONFIG_PACKAGE_kmod-sched-core=y
          
          # 3. 运行时库支持
          CONFIG_PACKAGE_libmnl=y
          CONFIG_PACKAGE_libnetfilter-queue=y
          CONFIG_PACKAGE_libnetfilter-conntrack=y
          CONFIG_PACKAGE_libnetfilter-cthelper=y
          CONFIG_PACKAGE_libnftnl=y
          CONFIG_PACKAGE_libevent2=y
          CONFIG_PACKAGE_libmosquitto=y
          CONFIG_PACKAGE_libevent2-openssl=y
          
          # 4. 调试与 eBPF 工具
          CONFIG_PACKAGE_bpftool-minimal=y
          # 网络与 eBPF 核心 (防止 GPF)
          CONFIG_PACKAGE_kmod-sched-bpf=y
          CONFIG_PACKAGE_kmod-sched-core=y
          CONFIG_PACKAGE_kmod-nfnetlink-queue=y
          CONFIG_PACKAGE_kmod-nf-conntrack-netlink=y
          
          # 必需的协议支持
          CONFIG_PACKAGE_kmod-nft-tproxy=y
          CONFIG_PACKAGE_kmod-ipt-tproxy=y
          
          # 确保 BPF 字节码可以被正确加载
          CONFIG_PACKAGE_libbpf=y
          CONFIG_PACKAGE_bpftool-minimal=y
          CONFIG_KERNEL_BPF_EVENTS=y
          CONFIG_KERNEL_DEBUG_INFO_BTF=y
          CONFIG_PACKAGE_kmod-sched-bpf=y
          EOF
          
          # 刷新索引并应用配置
          make defconfig
          
          echo "Compiling base libraries..."
          # 24.10 SDK 中，直接使用包名通常比全路径更稳
          make package/libmnl/compile V=s
          make package/libnetfilter-queue/compile V=s
          make package/libnetfilter-cthelper/compile V=s
          
          echo "Compiling apfree-wifidog..."
          make package/apfree-wifidog/compile V=s
          
          echo "Compiling Luci app..."
          make package/luci-app-apfree-wifidog/compile V=s

      - name: Inspect IPK Contents (Verify Patch)
        working-directory: openwrt-sdk
        run: |
          echo "=== Generated IPK Files ==="
          find bin/ -name "apfree-wifidog*.ipk"
          
          IPK_FILE=$(find bin/ -name "apfree-wifidog*.ipk" | grep -v "luci" | head -n 1)
          if [ -f "$IPK_FILE" ]; then
            echo "Checking contents of $IPK_FILE"
            # 列出 data.tar.gz 里的内容，确认是否有可执行文件
            tar -ztf "$IPK_FILE"
          else
            echo "Main IPK not found!"
          fi

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: apfree-wifidog-x86_64
          path: |
            openwrt-sdk/bin/packages/x86_64/**/*.ipk
            openwrt-sdk/bin/targets/x86/64/packages/*.ipk
