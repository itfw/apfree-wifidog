name: Build apfree-wifidog IPK
on:
  workflow_dispatch:
   push:
     branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Install system dependencies
        run: |
          sudo apt update
          sudo apt install -y --no-install-recommends \
            build-essential clang flex bison g++ gawk gcc-multilib \
            gettext git libncurses-dev libssl-dev rsync unzip \
            zlib1g-dev file wget curl python3

      - name: Download SDK from Aliyun
        run: |
          SDK_URL="https://mirrors.aliyun.com/openwrt/releases/24.10.5/targets/x86/64/openwrt-sdk-24.10.5-x86-64_gcc-13.3.0_musl.Linux-x86_64.tar.zst"
          echo "Downloading SDK from Aliyun: $SDK_URL"
          wget -q "$SDK_URL" -O sdk.tar.zst

          if [ ! -s sdk.tar.xz ]; then
            echo "SDK download failed (file empty). Check if 24.10.5 exists!"
            exit 1
          fi

          
          sudo apt-get update
          sudo apt-get install -y zstd
          tar -I zstd -xf sdk.tar.zst
          mv openwrt-sdk-* sdk
          cd sdk && pwd

      - name: Add apfree-wifidog feed (from liudf0716)
        run: |
          cd sdk
          # Add custom feed containing apfree-wifidog
          echo "src-git liudf0716 https://github.com/liudf0716/chawrt-packages.git" >> feeds.conf
          
          # Optional: Use China mirror for official feeds (speed up)
          sed -i 's|https://github.com/openwrt|https://mirrors.tuna.tsinghua.edu.cn/git/openwrt|g' feeds.conf

          ./scripts/feeds update -a
          ./scripts/feeds install -a apfree-wifidog

      - name: Configure and compile apfree-wifidog
        run: |
          cd sdk
          # Enable the package in config
          echo "CONFIG_PACKAGE_apfree-wifidog=y" > .config
          make defconfig

          # Keep-alive to prevent GitHub timeout
          while true; do echo "â³ Building apfree-wifidog... $(date)"; sleep 300; done &
          KEEPALIVE_PID=$!

          # Compile only this package
          make package/apfree-wifidog/compile V=s -j$(nproc)

          kill $KEEPALIVE_PID || true

      - name: Find and upload IPK
        id: find_ipk
        run: |
          IPK_FILE=$(find sdk/bin/packages -name "apfree-wifidog_*.ipk" | head -n1)
          if [ -z "$IPK_FILE" ]; then
            ls -R sdk/bin/  # debug
            exit 1
          fi
          echo "ipk_path=$IPK_FILE" >> $GITHUB_ENV
          echo "Found IPK: $IPK_FILE"
          ls -lh "$IPK_FILE"

      - name: Upload apfree-wifidog IPK
        uses: actions/upload-artifact@v4
        with:
          name: apfree-wifidog-openwrt-24.10-x86_64
          path: ${{ env.ipk_path }}
          retention-days: 7
